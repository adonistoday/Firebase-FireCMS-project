<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Finder | City Guide | Home v.1</title>
    <!-- SEO Meta Tags-->
    <meta name="description" content="Finder - Directory &amp; Listings Bootstrap Template">
    <meta name="keywords" content="bootstrap, business, directory, listings, e-commerce, car dealer, city guide, real estate, job board, user account, multipurpose, ui kit, html5, css3, javascript, gallery, slider, touch">
    <meta name="author" content="Createx Studio">
    <!-- Viewport-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon and Touch Icons-->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="mask-icon" color="#5bbad5" href="safari-pinned-tab.svg">
    <meta name="msapplication-TileColor" content="#766df4">
    <meta name="theme-color" content="#ffffff">
    <!-- Page loading styles-->
    <style>
      .page-loading {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        -webkit-transition: all .4s .2s ease-in-out;
        transition: all .4s .2s ease-in-out;
        background-color: #fff;
        opacity: 0;
        visibility: hidden;
        z-index: 9999;
      }
      .page-loading.active {
        opacity: 1;
        visibility: visible;
      }
      .page-loading-inner {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        text-align: center;
        -webkit-transform: translateY(-50%);
        transform: translateY(-50%);
        -webkit-transition: opacity .2s ease-in-out;
        transition: opacity .2s ease-in-out;
        opacity: 0;
      }
      .page-loading.active > .page-loading-inner {
        opacity: 1;
      }
      .page-loading-inner > span {
        display: block;
        font-size: 1rem;
        font-weight: normal;
        color: #666276;;
      }
      .page-spinner {
        display: inline-block;
        width: 2.75rem;
        height: 2.75rem;
        margin-bottom: .75rem;
        vertical-align: text-bottom;
        border: .15em solid #bbb7c5;
        border-right-color: transparent;
        border-radius: 50%;
        -webkit-animation: spinner .75s linear infinite;
        animation: spinner .75s linear infinite;
      }
      @-webkit-keyframes spinner {
        100% {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
        }
      }
      @keyframes spinner {
        100% {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
        }
      }
      @media ( max-width: 768px) {
        .col-md-6.mt-5.py-2{
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        .card.col-6.m-2{
          width: 100%;
        }

        #uptitle{
          height: 16vh !important;
        }
        .hidden-sp {
        display: none;
      }
      .navbar-brand {
        width: 100%;
        margin-right: 0 !important;
      }
      .navbar-toggler {
        position: absolute;
        top: 10px;
        right: 0;
      }
      .card.col-6.m-2 {
        width: 100%;
      }

      .card.col-4.m-4 {
        width: 100%;
      }

      .col.mb-5 {
        width: 100%;
      }

      .card.col-7.m-2 {
        width: 100%;
        margin: 0px !important;
      }

      .card.col-4.m-4 {
        width: 100% !important;
        margin: 0px !important;
      }

      #uptitle {
        height: 16vh !important;
      }

      .mt-2.btn.btn-danger.btn-sm.rounded-pill.ms-2.order-lg-3 {
        width: 96% !important;
        margin-left: 0px !important;
      }

      .input-group.input-group-lg.border-end-md {
        width: 100% !important;
      }
      header form{
        width: 100%;
      }
      header form .btn-search{
        margin-left:0 !important;
      }
      .link-for-business{
        width: 96% !important;
        margin-left: 0 !important;
      }
      }
      .bsr-photo {
        height: 7vw;
      }
      
    </style>
    <!-- Page loading scripts-->
    <script>
      (function () {
        window.onload = function () {
          var preloader = document.querySelector('.page-loading');
          preloader.classList.remove('active');
          setTimeout(function () {
            preloader.remove();
          }, 2000);
        };
      })();
      
    </script>
    <!-- Vendor Styles-->
    <link rel="stylesheet" media="screen" href="vendor/simplebar/dist/simplebar.min.css"/>
    <link rel="stylesheet" media="screen" href="vendor/tiny-slider/dist/tiny-slider.css"/>
    <link rel="stylesheet" media="screen" href="vendor/flatpickr/dist/flatpickr.min.css"/>
    <!-- Main Theme Styles + Bootstrap-->
    <link rel="stylesheet" media="screen" href="css/theme.min.css">
  </head>
  <!-- Body-->
  <body>
    <!-- Page loading spinner-->
    <div class="page-loading active">
      <div class="page-loading-inner">
        <div class="page-spinner"></div><span>Loading...</span>
      </div>
    </div>
    <main class="page-wrapper">
      
    <!-- Navbar-->
    <header class="navbar navbar-expand-lg navbar-light fixed-top" data-scroll-header style="
     background-color: rgba(255,255,255,1);">
      <div class="container">
        <a class="navbar-brand me-5 me-xl-5" href="home.html"><img class="d-block mx-auto" src="img/logo/Logo.png"
            width="116" alt="Finder"></a>
        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
          aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span
            class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse order-lg-2" id="navbarNav">
          <!-- Search form-->
          <div class="mt-2 d-sm-flex">
            <form class="form-group d-block d-md-flex position-relative rounded-md-pill">
              <div class="input-group input-group-lg border-end-md" style="width: 60%;"><span
                  class="input-group-text text-muted rounded-pill ps-3">
                  <i class="fi-search"></i></span>
                <input class="form-control" type="text" placeholder="What are you looking for?">
              </div>
              <hr class="d-md-none my-2">
              <div class="">
                <div class="dropdown mb-sm-0 mb-3" data-bs-toggle="select">
                  <button class="btn btn-link btn-lg dropdown-toggle ps-2 ps-sm-3" type="button"
                    data-bs-toggle="dropdown"><i class="fi-list me-2"></i><span
                      class="dropdown-toggle-label">Businesses</span></button>
                  <input type="hidden">
                  <ul class="dropdown-menu" style="margin-top: 0px !important;">
                    <li><a class="dropdown-item" href="#"><i class="fi-bed fs-lg opacity-60 me-2"></i><span
                          class="dropdown-item-label">Businesses</span></a></li>

                    <li><a class="dropdown-item" href="#"><i class="fi-shopping-bag fs-lg opacity-60 me-2"></i><span
                          class="dropdown-item-label">Products</span></a></li>
                  </ul>
                </div>
              </div>
              <hr class="d-md-none my-2">
              <div class="d-sm-flex">
                <input class="form-control" type="text" placeholder="Where?">
              </div>
              <hr class="d-md-none my-2">
              <button class="btn btn-danger btn-lg rounded-pill w-100 w-md-auto ms-sm-3 btn-search" type="button">Search</button>
            </form>
          </div>
          <div class="text-center d-lg-none">
            <a class="mt-2 btn btn-danger btn-sm rounded-pill ms-2 order-lg-3"
              href="city-guide-add-business.html">Maiinn&nbsp;Rewards</a>
          </div>
          <div class="text-center">
            <a class="mt-2 btn btn-sm text-danger d-lg-block order-lg-3 link-for-business" href="#signin-modal" data-bs-toggle="modal"><i
                class="fi-user me-2"></i>For Businesses</a>
          </div>
          <div class="text-center hidden-sp">
            <a class="mt-2 btn btn-danger btn-sm rounded-pill ms-2 order-lg-3"
              href="city-guide-add-business.html">Maiinn&nbsp;Rewards</a>
          </div>
        </div>
      </div>
    </header>
      <!-- Page content-->
      <!-- Hero-->
      <section class="container py-5 mt-5 mb-lg-3">
        <div class="row mt-4">
            <!-- Left column-->
          <div class="col-md-6 mb-md-0 mb-4 pb-md-0 pb-2" id="business_results">
            <h2 class="h4 mb-4">Business Search results in <span id="search_keyword"></span></h2>

            <!-- Review-->
            <!-- <div class="row mb-1 border rounded-1">
               
                <div class="col-12">
                  <div class="d-flex justify-content-between mb-1">
                    <div class="d-flex align-items-center pe-6">
                      <div class="mt-2 mb-2">
                        <h6 class="fs-base mb-0">IGA X-press Parramatta</h6>
                      </div>
                    </div>
                  </div>
                  <p class="mb-1">Address: Shop 6 & 7/330 Church St, Parramatta NSW 2150</p>
                  <p class="mb-1">Phone: (02) 8629 8808</p>
                </div>
            </div> -->
            

          </div>
          <!-- Sidebar-->
          <aside class="col-md-6 mt-5 py-2">
            <!-- Location (Map)-->
            <div style="height: 600px;" id="map">

            </div>
                <!-- <iframe style="height: 600px;" src="http://maps.google.com/maps?q=12.927923,77.627108&z=15&output=embed" allowfullscreen></iframe> -->
            
          </aside>
        </div>
        
      </section>





      
    </main>
    <footer class="footer bg-dark text-light">
      <div class="m-3 justify-content-between">
        <div class="row gy-4 d-flex align-items-center">
          <div class="col-lg-2 text-center">
            <a class="d-inline-block" href="home.html"><img src="img/logo/Logo White.png" width="100" alt="Logo"></a>
          </div>
          <div class="col-lg-2 text-center">
            <h3 class="fs-base text-light mb-0">Home</h3>
          </div>
  
          <div class="col-lg-2 text-center">
            <h3 class="fs-base text-light mb-0">Rewards</h3>
          </div>
          <div class="col-lg-2 text-center">
            <h3 class="fs-base text-light mb-0">Contact</h3>
          </div>
          <!-- Subscription form-->
          <div class="col-lg-4">
            <form class="form-group form-group-light rounded-pill" style="max-width: 500px;">
              <div class="input-group input-group-sm"><span class="input-group-text text-muted"><i
                    class="fi-mail"></i></span>
                <input class="form-control" type="email" placeholder="Your email">
              </div>
              <button class="btn btn-primary btn-sm rounded-pill" type="button">Subscribe</button>
            </form>
          </div>
        </div>
      </div>
    </footer>
    <!-- Back to top button--><a class="btn-scroll-top" href="#top" data-scroll><span class="btn-scroll-top-tooltip text-muted fs-sm me-2">Top</span><i class="btn-scroll-top-icon fi-chevron-up">   </i></a>
    <!-- Vendor scrits: js libraries and plugins-->
    <script src="vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="vendor/simplebar/dist/simplebar.min.js"></script>
    <script src="vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>
    <script src="vendor/tiny-slider/dist/min/tiny-slider.js"></script>
    <script src="vendor/flatpickr/dist/flatpickr.min.js"></script>
    <!-- Main theme script-->
    <script src="js/theme.min.js"></script>
    <script>
      function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
      const R = 6371; // Radius of the earth in km
      const dLat = deg2rad(lat2-lat1);  // deg2rad below
      const dLon = deg2rad(lon2-lon1); 
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      const d = R * c; // Distance in km
      return d;
      }

      function deg2rad(deg) {
        return deg * (Math.PI/180)
      }

    </script>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-analytics.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore.js";
      import { collection, doc, setDoc,getDocs} from "https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDm6z01-F-JhvfhWZt0abyU5OchwyyYdMc",
        authDomain: "maiinn.firebaseapp.com",
        projectId: "maiinn",
        storageBucket: "maiinn.appspot.com",
        messagingSenderId: "72086465434",
        appId: "1:72086465434:web:203eef22bd420f80816823",
        measurementId: "G-JTL518XJMC"
      };
      //Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);

      const db=getFirestore(app);
      
      const businessRef=collection(db,"Dummy-business-list");
      const business_docsSnap = await getDocs(businessRef);

      const urlParams = new URLSearchParams(window.location.search);
      const search_what = urlParams.get('what');
      const search_where = urlParams.get('where');

      var keyword_span=document.getElementById("search_keyword");
      keyword_span.innerHTML=search_what+", "+search_where;

      const list = [];

      // Loop through the documents in the "au-towns" collection and add their IDs to the list
      business_docsSnap.forEach(doc => {
        if(doc.data()["Business name"].includes(search_what)&&doc.data()["Address"].includes(search_where))
          list.push(doc.data());
      });
      console.log(list[0]["Address"]);
      const geocoder = new google.maps.Geocoder();
      const locations=[];
      list.forEach(doc=>{
        geocoder.geocode({ address: doc["Address"] }, (results, status) => {
            if (status === "OK") {
              locations.push(results[0].geometry.location);
            }
          });
      });
      
      geocoder.geocode({ address: list[0]["Address"] }, (results, status) => {
            if (status === "OK") {
              const location = results[0].geometry.location;
              console.log("Latitude: " + location.lat());
              console.log("Longitude: " + location.lng());
              const map = new google.maps.Map(document.getElementById("map"), {
              zoom: 15,
              center: location,
            });
            // Add a marker for the location
            list.forEach(doc=>{
              geocoder.geocode({ address: doc["Address"] }, (results, status) => {
        if (status === "OK") {
          const markerLocation = results[0].geometry.location;
          const distance = getDistanceFromLatLonInKm(location.lat(),location.lng(),markerLocation.lat(),markerLocation.lng())*1000;
          console.log(distance);
          if(distance<=5000){
            new google.maps.Marker({
            position: markerLocation,
            map: map,
            title: doc["Name"],
          });
          }
          
        } else {
          console.log(
            "Geocode was not successful for the following reason: " + status
          );
        }
      });
    });
  }else {
              console.log("Geocode was not successful for the following reason: " + status);
            }
      });
      // // Get the div element with ID "business_results"
       var businessResultsDiv = document.getElementById("business_results");

      // // Retrieve the results array from the query parameter
      // var resultsJson = decodeURIComponent(window.location.search.substr(1).split('=')[1]);
      // var results = JSON.parse(resultsJson);
    
      // Display the search results
      list.forEach(doc => {
        var name = doc["Business name"];
        var address_ = doc["Address"];
        console.log(name, address_);
        // Create a div element with the classes "row", "mb-1", "border", and "rounded-1"
        var div = document.createElement("div");
        div.className = "row mb-1 border rounded-1";

        // Create a div element with the class "col-12"
        var innerDiv = document.createElement("div");
        innerDiv.className = "col-12";

        // Create a div element with the class "d-flex justify-content-between mb-1"
        var subDiv = document.createElement("div");
        subDiv.className = "d-flex justify-content-between mb-1";

        // Create a div element with the class "d-flex align-items-center pe-6"
        var subSubDiv = document.createElement("div");
        subSubDiv.className = "d-flex align-items-center pe-6";

        // Create a div element with the classes "mt-2" and "mb-2"
        var nameDiv = document.createElement("div");
        nameDiv.className = "mt-2 mb-2";

        // Create an h6 element with the class "fs-base" and the text "IGA X-press Parramatta"
        var nameHeader = document.createElement("h6");
        nameHeader.className = "fs-base mb-0";
        nameHeader.textContent = name;

        // Append the name header to the name div
        nameDiv.appendChild(nameHeader);

        // Append the name div to the sub-sub div
        subSubDiv.appendChild(nameDiv);

        // Append the sub-sub div to the sub div
        subDiv.appendChild(subSubDiv);

        // Create a p element with the text "Address: Shop 6 & 7/330 Church St, Parramatta NSW 2150"
        var address = document.createElement("p");
        address.className="mb-1";
        address.textContent = "Address:"+address_;

        // Create a p element with the text "Phone: (02) 8629 8808"
        var phone = document.createElement("p");
        phone.className="mb-1";
        phone.textContent = "Phone: (02) 8629 8808";

        // Append the address and phone elements to the inner div
        innerDiv.appendChild(address);
        innerDiv.appendChild(phone);

        // Append the sub div and inner div to the main div
        div.appendChild(subDiv);
        div.appendChild(innerDiv);
        // Append the main div to the business results div
        businessResultsDiv.appendChild(div);
        // Display the name and address on the page as desired
    });
    </script>
    
    <script>
      function initMap() {
        var resultsJson = decodeURIComponent(window.location.search.substr(1).split('=')[1]);
        var results = JSON.parse(resultsJson);
        var places=results;
        console.log(places.length); 
        // Create a new map centered on the first place
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 16,
          center: { lat: places[0].geometry.location.lat, lng: places[0].geometry.location.lng },
        });

        // Add a marker for each place
        places.forEach((place) => {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: place.address }, (results, status) => {
            if (status === "OK") {
              const location = results[0].geometry.location;
              new google.maps.Marker({
                position: location,
                map: map,
                title: place.name,
              });
            } else {
              console.log("Geocode was not successful for the following reason: " + status);
            }
          });
        });
      }

      // Array of places with name, latitude, and longitude coordinates
      // const places = [
      //   { name: "Place A", lat: 40.7128, lng: -74.006 },
      //   { name: "Place B", lat: 37.7749, lng: -122.4194 },
      //   { name: "Place C", lat: 51.5074, lng: -0.1278 },
      // ];

      // Load the Google Maps API asynchronously
      function loadMapsScript() {
        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyA8OtxkAhwGqPIF1Ep5u-MkgtUDr-nCXAg&callback=initMap`;
        script.defer = true;
        script.async = true;
        document.head.appendChild(script);
      }

      // Call the loadMapsScript function to load the API
      loadMapsScript();
    </script>
    <script>
    </script>
  </body>
</html>